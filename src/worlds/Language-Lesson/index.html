<html>
<head>
  <!-- Circles' head scripts [REQUIRED] -->
  <circles-start-scripts/>

  <script src="https://rawcdn.githack.com/elbobo/aframe-gltf-morph-component/07e9b80bd382cc1c19223468d35c453e7c76e9a2/dist/aframe-gltf-morph-component.js"></script>

  <!-- video UI -->
  <script src="/worlds/Hub-360View/scripts/video3d-swap.js"></script>
  <script src="/worlds/Hub-360View/scripts/play-pause.js"></script>

  <script src="/worlds/Language-Lesson/scripts/animal-script.js"></script>
</head>
<body>
  <!-- 2D UI elements overylayed on the 3D scene for user options -->
  <circles-basic-ui/>
  
  <!-- this is used to create our enter UI that creates a 2D overlay to capture a user gesture for sound/mic access etc. -->
  <circles-start-ui/>

  <!-- a-scene with 'circles-properties' component [REQUIRED] -->
  <a-scene circles_scene_properties>
    <a-assets>

      <!-- Circles' built-in assets [REQUIRED] -->
      <circles-assets/>

      <!-- 3D Models -->
      <a-asset-item id="stump-gltf"  src="/worlds/Language-Lesson/assets/models/detailed_spruce_tree_stump.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="forest-floor-gltf"  src="/worlds/Language-Lesson/assets/models/mossy_ground.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="canoe-gltf"  src="/worlds/Language-Lesson/assets/models/canoe.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="spruce-gltf"  src="/worlds/Language-Lesson/assets/models/spruce_tree.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="moose-gltf"  src="/worlds/Language-Lesson/assets/models/moose.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="wolf-gltf"  src="/worlds/Language-Lesson/assets/models/wolf.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="crow-gltf"  src="/worlds/Language-Lesson/assets/models/crow_01.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="navmesh_gltf" src="/worlds/Campfire/assets/models/campfire-nav.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="enviro-gltf"    src="/worlds/Language-Lesson/assets/models/hubenviro_02.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>
      <a-asset-item id="water-edge-gltf"    src="/worlds/Language-Lesson/assets/models/waterEdge.glb" response-type="arraybuffer" preload="auto" crossorigin="anonymous"></a-asset-item>

      <video id="video3D" src="/worlds/360-Demo/assets/videos/canoe_360_01.mp4" muted loop="true" preload="auto" crossorigin="anonymous"></video>
      <video id="video3D_canoe" src="/worlds/360-Demo/assets/videos/canoe_360_04.mp4" muted loop="true" crossorigin="anonymous"></video>

      <audio id="forest-sound" src="/worlds/Language-Lesson/assets/sounds/forest-atmosphere.mp3" loop="true" autoplay preload="auto" crossorigin="anonymous"></audio>
      <audio id="greeting-sound" src="/worlds/Language-Lesson/assets/sounds/Walter_Peter_greeting.mp3" preload="auto" crossorigin="anonymous"></audio>
      <audio id="greeting-wolf-sound" src="/worlds/Language-Lesson/assets/sounds/Walter_Peter_greeting_wolf.mp3" preload="auto" crossorigin="anonymous"></audio>
      <audio id="greeting-crow-sound" src="/worlds/Language-Lesson/assets/sounds/Walter_Peter_greeting_raven.mp3" preload="auto" crossorigin="anonymous"></audio>

      <!-- play / pause button -->
      <img id="play" src="/global/assets/textures/icons/icon-play.png" crossorigin="anonymous">
      <img id="pause" src="/global/assets/textures/icons/icon-pause.png" crossorigin="anonymous">

      <img id="moose-label" src="/worlds/Language-Lesson/assets/images/moose_label.png" crossorigin="anonymous">
      <img id="crow-label" src="/worlds/Language-Lesson/assets/images/raven_label.png" crossorigin="anonymous">
      <img id="wolf-label" src="/worlds/Language-Lesson/assets/images/wolf_label.png" crossorigin="anonymous">

    </a-assets>

    <!-- Circles' built-in manager and avatar [REQUIRED] -->
    <circles-manager-avatar/>

    <!-- start your code: put your A-frame, Circles XR, and custom components here -->
    <a-entity
      gltf-model="#enviro-gltf"
      shadow="receive: true; cast: true"
      circles-sound="src: #forest-sound; loop: true;  volume: 0.3; autoplay: true;"></a-entity>
    <a-entity
      gltf-model="#water-edge-gltf"
      shadow="receive: true; cast: true"></a-entity>

    <a-entity id="stump"
              position="0.46 0.05 -1.45" rotation="0 140 0" scale="1.25 2.2 1.25"
              gltf-model="#stump-gltf"
              shadow="receive: true; cast: true"></a-entity>

    <a-entity id="forest-floor"
              position="2.108 -0.1 0.504" rotation="-0.22 -128 1.048" scale="4.36 3 4.78"
              gltf-model="#forest-floor-gltf"
              shadow="receive: true; cast: false"></a-entity>

    <a-entity id="spruce"
              rotation="0 90 0" scale="1.75 1 1.75"
              gltf-model="#spruce-gltf"
              shadow="receive: true; cast: true"></a-entity>

    <!-- The animals -->
    <a-entity id="moose"
              animal
              position="4 0.1 6.6" rotation="0 50 0" 
              gltf-model="#moose-gltf" shadow="receive: true; cast: true"
              animation-mixer="clip: Armature|Take*; loop: repeat; repetitions: 5;"
              animation__pos="property: position; to: 1.8 0.1 2.4; dur: 7000; easing: linear; loop: false; autoplay: true;"
              animation__rot="property: rotation; to: 0 0 0; delay: 6000; dur: 1000; easing: linear; loop: false; autoplay: true;"
              circles-interactive-object="type: scale; click_sound: #greeting-sound;"
              circles-sound="src: #greeting-sound; type: dialogue;  volume: 3;"
              onclick="document.getElementById('moose').emit('speak', {value: 'moose'});">
              <!--
              <a-entity
                position="0.7 1 -1"
                circles-label="text: denya패k; arrow_position:up;"></a-entity>
              <a-text text="value:denya패k; align:center" 
                      geometry="primitive:plane; height:0.3; width:0.9"
                      material="color: black" scale="0.6 0.6 0.6" position="0.7 1 -1" width="3.5"
                      circles-lookat="constrainYAxis: false;"></a-text> -->
              <a-image  src="#moose-label"
                        position="0.7 1 -1" scale="0.25 0.15 0.25"
                        circles-lookat="constrainYAxis: false;"></a-image>
    </a-entity>
    <a-entity id="wolf"
              animal
              position="1.35 0 -3.5" rotation="0 41 0" scale="0.6 0.6 0.6"
              gltf-model="#wolf-gltf" shadow="receive: false; cast: true"
              animation-mixer="clip: Animation*; loop: once;"
              circles-interactive-object="type: scale; click_sound: #greeting-wolf-sound;"
              circles-sound="src: #greeting-wolf-sound; type: dialogue; volume: 3;"
              onclick="document.getElementById('wolf').emit('speak', {value: 'wolf'});">
              <!--
              <a-entity 
                position="0 1 1.5"
                circles-label="text: agay; arrow_position:up;">
              </a-entity>
              <a-text text="value:agay; align:center" 
                      geometry="primitive:plane; height:0.3; width:0.6"
                      material="color: black" scale="0.8 0.8 0.8" position="0 1 1.5" width="3.5"
                      circles-lookat="constrainYAxis: false;"></a-text> -->
              <a-image  src="#wolf-label"
                        position="0 1 1.5" scale="0.5 0.3 0.5"
                        circles-lookat="constrainYAxis: false;"></a-image>
    </a-entity>
    <a-entity id="crow"
              animal
              position="0.29 0.75 -1.45" rotation="0 26 0" scale="0.2 0.2 0.2"
              gltf-model="#crow-gltf" shadow="receive: true; cast: true" gltf-morph__key="morphtarget:Key 1; value:0;"
              animation__wingsClose="property: gltf-morph__key.value; to: 1; dur: 2000; startEvents: wingsClose;"
              animation__wingsOpen="property: gltf-morph__key.value; to: 0; dur: 2000; startEvents: wingsOpen;"
              animation-mixer="clip: FlyToIdle*; loop: once; clampWhenFinished: true;"
              circles-interactive-object="type: scale; click_sound: #greeting-crow-sound;"
              circles-sound="src: #greeting-crow-sound; type: dialogue;  volume: 3;"
              onclick="document.getElementById('crow').emit('speak', {value: 'crow'});">
              <a-entity 
                geometry="primitive: sphere; radius: 1;" visible="false"
                scale="2 2 2" position="0 1.75 0"
                circles-interactive-object="type: scale;">
              </a-entity>
              <!--
              <a-entity 
                scale="2 2 2" position="0 1 2.5"
                circles-label="text: ts'e패hk'i; arrow_position:up;">
              </a-entity> 
              <a-text text="value:ts'e패hk'i; align:center" 
                      geometry="primitive:plane; height:0.3; width:0.8"
                      material="color: black" scale="1.5 1.5 1.5" position="0 1.75 2.5" width="3.5"
                      circles-lookat="constrainYAxis: false;"></a-text>-->
              <a-image  src="#crow-label"
                        position="0 1.75 2" scale="1 0.6 1"
                        circles-lookat="constrainYAxis: false;"></a-image>
    </a-entity>
    <a-entity id="canoe"
              position="24.6 0.2 -1.55" rotation="0 -36 0" scale="0.8 0.8 0.8"
              gltf-model="#canoe-gltf"
              shadow="receive: true; cast: true"></a-entity>
    <a-entity id="canoe-point"
              circles-checkpoint
              position="24.6 -0.25 -1.55"
              visible="false"></a-entity>

    <a-videosphere  id="video3D-canoe"
                    src="#video3D_canoe"
                    position="24.6 1.5 -1.55"
                    scale="0.001 0.001 0.001"
                    circles-interactive-object
                    circles-interactive-visible
                    video3d-swap
                    circles-sendpoint="target:#canoe-point"
                    onclick="document.getElementById('video3D-canoe').setAttribute('circles-interactive-visible', 'false'); document.getElementById('video3D-tree').setAttribute('circles-interactive-visible', 'true');"
                    ></a-videosphere>
    <a-videosphere  id="video3D_main"
                    src="#video3D"
                    rotation="0 145 0"
                    ></a-videosphere>

    <a-entity id="navmesh" gltf-model="#navmesh_gltf" visible='false' nav-mesh></a-entity>

    <a-entity id="spawn-point"
              circles-checkpoint
              circles-spawnpoint
              position="6.7f 0f -0.9f"></a-entity>
    <a-videosphere  id="video3D-tree"
                    src="#video3D"
                    position="7.6f 1.5f 0.8f"
                    scale="0.001 0.001 0.001"
                    circles-interactive-object
                    circles-interactive-visible="false"
                    video3d-swap
                    circles-sendpoint="target:#spawn-point"
                    onclick="document.getElementById('video3D-tree').setAttribute('circles-interactive-visible', 'false'); document.getElementById('video3D-canoe').setAttribute('circles-interactive-visible', 'true');"
                    ></a-videosphere>

    
    <a-image  id="videoControls"
              src="#play"
              position="9.5 1 -3" rotation="0 -90 0"
              play-pause
              circles-interactive-object="type:scale; click_sound:#toggle_snd"
              circles-lookat></a-image>

    <!-- end your code: -->
  </a-scene>
  <script>
    //This is a bandaid fix for the disappearing crow bug. Not really efficient but it works.
    var el = document.getElementById('crow');
    el.addEventListener('model-loaded', () => {
      const model = el.getObject3D('mesh');
      model.traverse((node) => {
        if (node.isMesh) {
          node.frustumCulled = false;
        }
      });
    });
  </script>

  <!-- Circles' end scripts [REQUIRED] -->
  <circles-end-scripts/>
 </body>
</html>