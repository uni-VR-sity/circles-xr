<script>
  // Prompt for audio.
  if (CIRCLES.CONSTANTS.CIRCLES_WEBRTC_ENABLED && CIRCLES.CONSTANTS.CIRCLES_MIC_ENABLED) {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded');
      const scene = document.querySelector('a-scene');
      scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
        console.log('adapter-ready');
        const clientId = CIRCLES.getUUID(); // generate a random 16 characters string, but you can use a uuid4 for example
        adapter.setClientId(clientId);
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          adapter.setLocalMediaStream(stream).then(() => {
            // Note that networked-scene audio:true option has no effect with the janus adapter
            NAF.connection.adapter.enableMicrophone(false); // set it to false if you want to be muted initially.
          });
        }).catch(err => {
          console.warn("Microphone access not allowed. This client will not broadcast audio.");
        });
      });
    });
  }
  else {
    //disable HTML mic elements
    document.querySelector('#button_microphone').style.display = 'none';
    document.querySelector('#user-microphone-wrapper').style.display = 'none';
  }

  var modelsReady = false;

  var circleTransitioner = document.querySelector('[circles-transition]');

  // Indicating server is ready right away since there is no networking
  // Making sure transitioner is defined
  var TransitionerCheckInterval = setInterval(function()
  {
    if (circleTransitioner.components['circles-transition'])
    {
      // Indicating server is ready in transitioner
      circleTransitioner.components['circles-transition'].setServerReady();

      clearInterval(TransitionerCheckInterval);
    }
  }, 100);

  // Called by circles-model-loader when all models are loaded in scene
  async function onModelLoad()
  {
    console.log('models loaded');

    // Making sure transitioner is defined
    var TransitionerCheckInterval = setInterval(function()
    {
      if (circleTransitioner.components['circles-transition'])
      {
        // Indicating models are ready in transitioner
        circleTransitioner.components['circles-transition'].setModelsReady();

        clearInterval(TransitionerCheckInterval);
      }
    }, 100);
    
    //modelsReady = true;
    //enterCircle();
  }

  // If there is no circles-model-manager in scene, calling onModelLoad()
  if (document.querySelectorAll('[circles-model-manager]').length == 0)
  {
    onModelLoad();
  }

  // Allowing user to enter circle
  function enterCircle()
  {
    // If both server and models are ready
    if (modelsReady)
    {
      //depending on scene loaded results in the mic button not working if clicked too fast
      //it also means the mic button has no effect (when 'adapter-ready' fires the mic also cannot be enabled/diabled) ...
      //I am not sure this is the best way to do this; but audio feedback is even worse ...
      document.querySelector('#loading-animation-enter').style.display='none';
      document.querySelectorAll('.user-gesture-button').forEach((elem)=> {
        //if entering the wardrobe world no need to show "enter wardrobe button"
        if (window.location.pathname.match(/wardrobe/i)) {
          if (elem.id !== 'wardrobe-enter') {
            elem.style.display='block';
          }
        }
        else {
          elem.style.display='block';
        }
      });

      //need to re-direct to wardrobe world if the user isn't "dressed" yet
      //make sure we add all urlParams together from provided link and existing url bar
      //const queryString = ((window.location.search) ? window.location.search + '&' : '?') + ((urlArr.length > 1) ? urlArr[1] : window.location.search);

      //we want to know if we have visited a world already during this session ...
      //const urlParams = new URLSearchParams(queryString);
      //urlParams.append('last_route', window.location.pathname);
      // if (!urlParams.has('last_route')) {
      //   urlParams.append('last_visited', '1');
      // }

      //mic sometimes is on for some reason
      if (CIRCLES.CONSTANTS.CIRCLES_WEBRTC_ENABLED && CIRCLES.CONSTANTS.CIRCLES_MIC_ENABLED) {
        NAF.connection.adapter.enableMicrophone(false);
      }
    }
  }

</script>